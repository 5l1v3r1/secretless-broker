#!/bin/bash -e

REPOSITORY="github.com/conjurinc/secretless"

pushd $(dirname $0) >/dev/null
trap 'popd >/dev/null' EXIT INT QUIT

echo "Cleaning up generated files..."
rm -rf ../generated/*.html

echo "Reading and generating godoc pages..."
cat ../godoc_packages.txt | while read package; do
  if [[ "${package}" =~ ^\#.* ]] || [[ "${package}" == "" ]]; then
    continue
  fi

  sanitized_package_name="${package//\//_}"
  package_file="${sanitized_package_name//\//_}.html"
  output_file="../generated/${package_file}"
  echo "Creating: $output_file"

  echo "---
layout: docs
id: ${sanitized_package_name}
title: Secretless
description: Secretless
godoc: True
godoc_repository: ${REPOSITORY}
godoc_package: ${package}
---

<h3>Package import</h3>
" > "${output_file}"

  # Generate the doc but strip out the header boilerplate and links
  godoc -html -links=false "${REPOSITORY}/${package}" | sed 1,19d >> "${output_file}"
done

