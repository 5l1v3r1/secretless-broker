#!/bin/bash

set -eo pipefail

current_dir=$("$(dirname "$0")"/abspath)
toplevel_dir=$current_dir/..

junit_output_dir=$toplevel_dir/test/unit-test-output
mkdir --parents "$junit_output_dir"
junit_output_file=$junit_output_dir/junit.output

rm -f "$junit_output_file"
touch "$junit_output_file"

echo "Building unit test image..."
docker build "$toplevel_dir" \
             -t secretless-unit-test-runner:latest \
             -f "$toplevel_dir"/Dockerfile.test

echo "Running unit tests..."
set +e
  # TODO: Use `go vet` too
  docker run --rm -t secretless-unit-test-runner:latest \
             -vet=off \
             ./cmd/... \
             ./internal/... \
             ./pkg/... \
             | tee -a "$junit_output_file"
  echo "Unit test exit status: $?"
set -e

rm -f "$junit_output_dir"/junit.xml

docker run --rm \
  --volume "$junit_output_dir"/:/secretless/test/output/ \
  secretless-dev \
  bash -exc "
    cat ./test/output/junit.output | go-junit-report > ./test/output/junit.xml
  "
