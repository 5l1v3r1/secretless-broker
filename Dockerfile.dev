FROM golang:1.10.3-stretch
MAINTAINER Conjur Inc.

RUN apt-get update && \
    apt-get install -y curl \
                       jq \
                       less \
                       vim

WORKDIR /go/src/github.com/conjurinc/secretless

RUN curl -fsSL -o /usr/local/bin/dep \
    https://github.com/golang/dep/releases/download/v0.4.1/dep-linux-amd64 && \
    chmod +x /usr/local/bin/dep

RUN go get -u github.com/jstemmer/go-junit-report && \
    go get github.com/smartystreets/goconvey && \
    go get golang.org/x/tools/cmd/goimports

COPY Gopkg.toml Gopkg.lock ./

# TODO: Expand this with build args when we support other arches
ENV GOOS=linux \
    GOARCH=amd64 \
    CGO_ENABLED=1

RUN dep ensure --vendor-only

COPY . .

# Not strictly needed but we might as well do this step too since
# the dev may want to run the binary
RUN go build -o bin/$GOOS/$GOARCH/secretless ./cmd/secretless && \
    go build -o bin/$GOOS/$GOARCH/summon2 ./cmd/summon2
